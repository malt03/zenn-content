---
title: "ctrlc ã‚ˆã‚Šã‚‚ç°¡å˜ã« Ctrl-C ã‚’æ¤œçŸ¥ã™ã‚‹ã€å°ã•ãª crate ã‚’ä½œã£ãŸ"
emoji: "ğŸª¶"
type: "tech"
topics: ["rust", "ctrlc", "signal", "cli"]
published: true
---

# å‰æ

CLI ãƒ„ãƒ¼ãƒ«ã‚’æ›¸ã„ã¦ã„ã‚‹ã¨ã€ŒCtrl-C ã‚’æ¤œçŸ¥ã—ãŸã„ã€ã¨ã„ã†å ´é¢ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚

ãã®åº¦ã«ã“ã‚“ãªå®Ÿè£…ã‚’æ›¸ãã‚ã‘ã§ã™ãŒã€ã©ã†ã«ã‚‚æ°—æŒã¡æ‚ªã„ã¨ãšã£ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚

```rust:main.rs
let flag = Arc::new(AtomicBool::new(false));
let f = flag.clone();

ctrlc::set_handler(move || {
    f.store(true, Ordering::SeqCst);
})?;

loop {
    if flag.load(Ordering::SeqCst) {
        println!("Ctrl-C detected");
        break;
    }

    // work...
}
```

- ç›®çš„ã®ã‚ã‚Šã«å®Ÿè£…ãŒ Too Much
- å†…éƒ¨å®Ÿè£…ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒæ°—ã«ãªã‚‹
- `Arc<AtomicBool>` ãŒå«Œã„

ãã“ã§ [`ctrlc-tiny`](https://crates.io/crates/ctrlc-tiny) ã¨ã„ã†ã€ŒCtrl-C ãŒæŠ¼ã•ã‚ŒãŸã‹ã‚’çŸ¥ã‚ŠãŸã„ã€ã ã‘ã«ç‰¹åŒ–ã—ãŸ crate ã‚’ä½œã‚Šã¾ã—ãŸã€‚

# ä½¿ã„æ–¹

```toml:Cargo.toml
ctrlc-tiny = "0.1"
```

```rust:main.rs
ctrlc_tiny::init_ctrlc()?;

loop {
    if ctrlc_tiny::is_ctrlc_received() {
        println!("Ctrl-C detected");
        break;
    }

    // work...
}
```

- `init_ctrlc()` ã§ãƒãƒ³ãƒ‰ãƒ©ã‚’ç™»éŒ²
- ã‚ã¨ã¯ `is_ctrlc_received()` ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ã ã‘
- AtomicBool ã‚„ Arc ã¨ã„ã£ãŸã€ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªå…±æœ‰çŠ¶æ…‹ã®ç®¡ç†ã‚’æ„è­˜ã™ã‚‹å¿…è¦ãŒãªã„

## Ctrl-C ã‚’è¤‡æ•°å›æ¤œçŸ¥ã—ãŸã„æ™‚ã¯

`reset_ctrlc_received()` ã¨ã„ã†é–¢æ•°ã‚’ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚
ã“ã‚“ãªå ´åˆã§ã‚‚ã€å…±æœ‰çŠ¶æ…‹ã®ç®¡ç†ã‚’æ„è­˜ã™ã‚‹å¿…è¦ã®ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ãŒå¯èƒ½ã§ã™ã€‚

```rust:main.rs
ctrlc_tiny::init_ctrlc()?;
let mut count = 0;

loop {
    if ctrlc_tiny::is_ctrlc_received() {
        ctrlc_tiny::reset_ctrlc_received();

        count += 1;
        println!("Detected Ctrl-C: {count}");

        if count == 10 {
            break;
        }
    }
}
```

:::message
`reset_ctrlc_received()` ã®å‘¼ã³å‡ºã—ã¨ SIGINT ã®å—ä¿¡ãŒä¸¦è¡Œã™ã‚‹ã¨ç«¶åˆãŒç™ºç”Ÿã—ã€SIGINT ã®å—ä¿¡ã‚’è¦‹é€ƒã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
:::

# å®Ÿè£…ã®é¢ç™½ã‹ã£ãŸã¨ã“ã‚

ä»Šå›ã®å®Ÿè£…ã¯ã€ã»ã¼ã™ã¹ã¦ C è¨€èªã§å®Œçµã—ã¦ãŠã‚Šã€Rust å´ã§ã¯ FFI çµŒç”±ã§ C é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

ã“ã‚Œã¾ã§ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã®ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¯è§¦ã£ã¦ãã¾ã›ã‚“ã§ã—ãŸãŒã€æƒ³åƒä»¥ä¸Šã«ã‚¯ã‚»ãŒã‚ã‚Šã€ãªã‹ãªã‹æ¥½ã—ã‹ã£ãŸã§ã™ã€‚

ç‰¹ã«ã€ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒ©ã®ä¸­ã§ä½¿ãˆã‚‹å¤‰æ•°ã‚„ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ¼ãƒ«ã¯ã‹ãªã‚Šé™ã‚‰ã‚Œã¦ãŠã‚Šã€[`async-signal-safe`](https://man7.org/linux/man-pages/man7/signal-safety.7.html)ãªå®Ÿè£…ã«ã™ã‚‹ãŸã‚ã«ã¯ã€ã‹ãªã‚Šæ°—ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ä»Šå›ã¯ `is_sigint_received` ã«ä»£å…¥ã™ã‚‹ã ã‘ãªã®ã§ã€ã‚ã‹ã‚Šã‚„ã™ã `async-signal-safe` ãªã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒ©ã‚’å®Ÿç¾ã§ãã¦ã„ã¾ã™ã€‚

```c:sigint.c
volatile sig_atomic_t is_sigint_received = 0;

void handle_sigint(int signo)
{
    (void)signo;
    is_sigint_received = 1;
}

int init_sigint_handler()
{
    struct sigaction sa = {0};
    sa.sa_handler = handle_sigint;
    sigemptyset(&sa.sa_mask);
    sa.sa_flags = SA_RESTART;
    return sigaction(SIGINT, &sa, NULL);
}

sig_atomic_t get_is_sigint_received()
{
    return is_sigint_received;
}
```

```rust:lib.rs
static INIT: Once = Once::new();

pub fn init_ctrlc() -> io::Result<()> {
    let mut result = Ok(());
    INIT.call_once(|| unsafe {
        if bindings::init_sigint_handler() != 0 {
            result = Err(io::Error::last_os_error());
        }
    });
    result
}

pub fn is_ctrlc_received() -> bool {
    unsafe { bindings::get_is_sigint_received() != 0 }
}
```

# çµ‚ã‚ã‚Šã«

æ­£ç›´ãªã¨ã“ã‚ã€`Arc` ã‚„ `AtomicBool`ã€ã‚ã‚‹ã„ã¯ `ctrlc` ã‚¯ãƒ¬ãƒ¼ãƒˆå†…éƒ¨ã®å®Ÿè£…ã«ã¤ã„ã¦ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çš„ã«ç¾å®Ÿçš„ãªå•é¡ŒãŒã‚ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

å€‹äººçš„ã€ä¸»è¦³çš„ãªæ°—æŒã¡æ‚ªã•ã¨ã€å®Ÿè£…ã®ã¡ã‚‡ã£ã¨ã—ãŸç…©é›‘ã•ã®è§£æ¶ˆãŒä»Šå›ã®ç›®çš„ã§ã€ãã®ç‚¹ã§ã¯æº€è¶³ã§ãã‚‹ä»•ä¸ŠãŒã‚Šã«ãªã£ãŸã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ã”æ„è¦‹ãƒ»æ”¹å–„æ¡ˆãªã©ã‚ã‚Œã° PR ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ï¼

- Crates.io: https://crates.io/crates/ctrlc-tiny
- GitHub: https://github.com/malt03/ctrlc-tiny
- Docs: https://docs.rs/ctrlc-tiny
